@startuml reverse_otp_fixed

participant User as user
participant MoMo_App as momo_app
participant SMS_App as sms_app
participant MoMo_Backend as backend
participant OTP_Service as otp_service

note across: Luồng OTP bình thường đã thất bại do user không nhận được OTP

autonumber

' == 1. Khởi tạo ==
momo_app -> user: Hiển thị tùy chọn "Gửi tin nhắn để xác thực"
user -> momo_app: Nhấn vào tùy chọn "Gửi tin nhắn để xác thực"
momo_app -> backend: Request: Khởi tạo luồng Reverse OTP

' == 2. Phản hồi từ Server ==
backend -> backend: 1. Tạo OTP (unique, single-use)\n2. Lưu (token, user_id, registered_phone)
backend --> momo_app: Response: { \n Cú pháp: "XACTHUCMOMO <OTP>",\n Số tổng đài: XXXX\n}

' == 3. Điều hướng phía Client ==
momo_app -> user: Hiển thị CTA "Gửi tin nhắn để xác thực"
user -> momo_app: Bấm CTA
momo_app -> sms_app: Mở SMS App với cú pháp và số tổng đài đã điền sẵn
sms_app -> user: Hiển thị màn hình soạn tin nhắn...
user -> sms_app: Bấm Gửi tin nhắn

' == 4. Gửi và xác thực ==
sms_app -> otp_service: Gửi tin nhắn đến số tổng đài \n(Nội dung: "XACTHUCMOMO <OTP>")
otp_service -> backend: { "sender_phone": "090xxxxxxx", \n "content": "XACTHUCMOMO <OTP>" }

backend -> backend: 1. Parse 'content' lấy 'OTP' \n2. Parse 'sender_phone' \n3. Tra cứu 'OTP' trong DB

alt token hợp lệ
    backend -> backend: Lấy 'registered_phone' đã lưu \nSo sánh 'sender_phone' VỚI 'registered_phone' \n So sánh OTP
    
    alt 'sender_phone' == 'registered_phone'
        backend -> backend: Xác thực người dùng thành công
        backend --> momo_app: Response: Xác thực thành công
        momo_app -> user: Gửi thông báo xác thực thành công
    else 'sender_phone' != 'registered_phone'
        backend -> backend: Xác thực thất bại (Sai SĐT gửi)
        backend --> momo_app: Response: Xác thực thất bại
        momo_app -> user: Gửi thông báo xác thực thất bại
    end

else token không hợp lệ
    backend -> backend: Xác thực thất bại (Sai token)
    backend --> momo_app: Response: Xác thực thất bại
    momo_app -> user: Gửi thông báo xác thực thất bại
end

@enduml